{% extends 'basePage.html' %}
{% load markdown_extras %}
{% load static %}
{% block content %}
{% load rest_framework %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{% static 'css/postview.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
    </script>
    <script src="https://unpkg.com/feather-icons@4.10.0/dist/feather.min.js"></script>
    <link rel="stylesheet" href={% static 'css/star.css' %}>
    <!-- <script src="/static/js/jquery-3.1.1.min.js"></script>
    <script src="/static/js/jquery.waypoints.min.js"></script> -->
    <script src={% static 'js/postView.js' %}></script>
    <script src={% static 'js/starRating.js' %}></script>
    <!-- <script src={% static 'css/postView.js' %}></script> -->
</head>
<style>
  button {
  display: inline-block;
  cursor: pointer;
  padding: 1rem 1.5rem;
  line-height: 1;
  margin-bottom: 1rem;
  color: #000;
  font-size: 1rem;
  font-weight: bold;
  border: 2px solid #000;
  border-radius: 2rem;
  background: #fff;
}

.share {
  list-style: none;
  margin: 0 auto 2rem;
}
.share li {
  float: none;
  display: inline-block;
}
.share button, .share a {
  float: left;
  display: block;
  height: 64px;
  width: 64px;
  margin: .5rem;
  padding: 1rem;
  border-radius: 50%;
  font-size: 0;
  color: #000;
  cursor: pointer;
  background: #fff;
  transition: all 150ms ease-in-out;
  border: 2px solid #000;
}
.share button:hover, .share button:focus,
.share a:hover, .share a:focus {
  background: #000;
}
.share button:hover svg, .share button:focus svg,
.share a:hover svg, .share a:focus svg {
  color: #fff;
}
/* Small devices (landscape phones, 544px and up) */
@media (min-width: 544px) {  
  h1 {font: size 1.5rem !important;} /*1rem = 16px*/
}
 
/* Medium devices (tablets, 768px and up) The navbar toggle appears at this breakpoint */
@media (min-width: 768px) {  
  h1 {font: size 2rem !important;} /*1rem = 16px*/
  #shareSocial ul li{
    display: grid;
  }
}
 
/* Large devices (desktops, 992px and up) */
@media (min-width: 992px) { 
  h1 {font: size 2.5rem !important;} /*1rem = 16px*/
  #shareSocial ul li{
    display: grid;
  }
}
 
/* Extra large devices (large desktops, 1200px and up) */
@media (min-width: 1200px) {  
  h1 {font: size 3rem !important;} /*1rem = 16px*/  
  #shareSocial ul li{
    display: grid;
  }  
}
</style>
<body>
    <div class="container-fluid d-flex flex-column" style="min-height: 100%;">
        <div class="row ">
            <div class="col-md-12 col-sm-12 col-lg-3 col-xl-3 order-md-2 order-sm-2 order-lg-1 order-xl-1 order-2" style="
            margin-block-start: 25%;">
                <div class="pt-5 pb-5 px-0"></div>
                
                <div class="card showOtherPost">
                    <h5 class="card-header text-center">Other Posts From {{ posts.owner.user_name }}</h5>
                    <div class="card-body">
                        <ul>
                            {% for p in other_post %}
                                <li>
                                    <p class="card-text">
                                        <a href={% url 'postView' p.id %} class="stretched-link" target="_blank" >{{ p.post_title }}</a>
                                    </p>
                                </li>
                            {% endfor %}
                        </ul>
                        <!-- <h5 class="card-title">Special title treatment</h5>
                        <p class="card-text">With supporting text below as a natural lead-in to additional content.</p> -->
                    </div>
                </div> 
                <br/>
                <div class="card text-center starCard">
                    <div id="rate" class="container-fluid" style="padding: 2px;">
                        <div id="starrating"></div>
                        </br>
                        <span id="ratVal"></span>
                        <script>
                            starCount={{ postRate }}
                            function sendData(val){
                                $.ajax({
                                    type:'POST',
                                    url:'{%url 'rating'%}',
                                    dataType:'JSON',
                                    data:{ 
                                        postTitle:val,
                                        postId:{{ posts.id }}   
                                    },
                                    success :function(response){
                                        if(response==true){
                                            // document.getElementById('ratVal').innerHTML="thank you for rating."
                                        }
                                    }
                                })
                            }
                        </script>
                    </div>
                </div> 
                <div class="justify-content-center" id="shareSocial" style="margin-block-start: 50%; ">
                  <ul class="share">
  
                    <!-- Facebook -->
                    <li>
                      <button onclick="window.open('https://facebook.com/share.php?u=https://sheltered-journey-30026.herokuapp.com/{% url 'postView' posts.id %}&amp;t={{ posts.post_title }}', '_blank', 'top=150,left=400,width=450,height=550')" title="Facebook"><i data-feather="facebook"></i></button>
                    </li>
                        
                    <!-- Twitter -->
                    <li>
                      <button class="share-twitter" onclick="window.open('https://twitter.com/intent/tweet?text=PAGE_TITLE_HERE&amp;url=PAGE_LINK_HERE&amp;via=USERNAME_HERE', '_blank', 'top=150,left=400,width=550,height=350')" title="Twitter"><i data-feather="twitter"></i></button>
                    </li>
                      
                    <!-- Linkedin -->
                    <li>
                      <button onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&amp;url=PAGE_LINK_HERE&amp;title=PAGE_TITLE_HERE&amp;summary=PAGE_DESCRIPTION_HERE&amp;source=PAGE_NAME_HERE', '_blank', 'top=150,left=550,width=450,height=650')" title="LinkedIn"><i data-feather="linkedin"></i></button>
                    </li>
                    
                     
                    <li>
                      <button onclick="window.open('https://pinterest.com/pin/create/button/?url=PAGE_LINK_HERE&media=MEDIA_LINK_HERE&description=PAGE_DESCRIPTION_HERE', '_blank', 'top=150,left=550,width=450,height=650')" title="Pinterest">Pinterest
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,0A12,12,0,0,0,7.63,23.17a11.7,11.7,0,0,1,0-3.44l1.41-6A4.33,4.33,0,0,1,8.72,12c0-1.67,1-2.92,2.17-2.92a1.51,1.51,0,0,1,1.52,1.69,23.74,23.74,0,0,1-1,4,1.73,1.73,0,0,0,1.77,2.17c2.13,0,3.77-2.25,3.77-5.49a4.73,4.73,0,0,0-5-4.88,5.18,5.18,0,0,0-5.41,5.2,4.62,4.62,0,0,0,.89,2.74.36.36,0,0,1,.08.35c-.09.38-.29,1.19-.34,1.36s-.17.27-.4.16c-1.49-.69-2.43-2.89-2.43-4.64,0-3.79,2.75-7.26,7.93-7.26,4.16,0,7.39,3,7.39,6.93,0,4.13-2.61,7.46-6.22,7.46a3.2,3.2,0,0,1-2.75-1.38s-.61,2.29-.75,2.85a13.28,13.28,0,0,1-1.49,3.15A12.2,12.2,0,0,0,12,24,12,12,0,0,0,12,0Z"></path></svg>
                      </button>
                    </li> 
                    
                    <!-- WhatsApp -->
                    <li>
                      <a href="whatsapp://send?text=PAGE_TITLE_HERE - PAGE_LINK_HERE" target="_blank" title="WhatsApp"><i data-feather="message-circle"></i></a>
                    </li>
                    
                  <!-- Email -->
                    <li>
                      <a href="mailto:?subject=PAGE_TITLE_HERE&amp;body=PAGE_LINK_HERE" rel="noopener" title="Email"><i data-feather="mail"></i></a>
                    </li>
                    
                  </ul>
                </div>
            </div>
            <div class="col-md-12 col-sm-12 col-lg-7 col-xl-7  blog-top order-md-1 order-sm-1 order-lg-2  order-xl-2 "
                style="padding-bottom: 10%;">
                <article class="blog-view">
                    <div class="justify-content-center">
                        <section>
                            <div style="padding-top: 2%;padding-bottom: 2%;">
                              <p class="text-center display-4" style="font-size: 4rem;font-weight: bold ;word-break: break-word; ">{{ posts.post_title }} </p>
                              </div>
                            <section>
                                <div class="row mt-5 justify-content-center ">
                                    <div class="offset-sm-1 offset-md-1 col-md-2 col-sm-2 col-2"> 
                                          <img src="{{ posts.owner.profile_pic_url }}" class="rounded-circle "
                                              style="height:40px; width:40px;margin-left:50%"> 
                                    </div>
                                    <div class="col-md-4 col-sm-4 col-4">
                                        <section>
                                            <span>{{ posts.owner.user_name }}</span>
                                        </section>
                                        <section>
                                            <h6 class="blog-post-meta">{{ posts.post_created|date:"Y-m-d "  }} </h6>
                                        </section>
                                    </div>
                                </div>
                            </section>
                        </section>
                    </div>
                    <section class="mt-5">
                        <img src="{% static '3.png'%}" class="img-fluid full-width">
                    </section>
                    <div class="mb-auto">
                        <section id="postBody">
                            <div class="container-fluid mt-5 mb-auto">
                                <script>
                                    postData = "{{ body_custom | escapejs}}";
                                </script>
                            </div>
                        </section>
                    </div>
                </article>
            </div>
            <div class="col-md-2 col-sm-2 col-lg-2 order-md-3 order-sm-3 order-lg-3 "></div>
        </div>
    </div>
    <hr/> 
    <br/>
    <br/>
    <style>
        @media screen and (min-width: 600px) {
          .children form {
            margin-left: -48px; 
          }
      
          .children .children form {
            margin-left: -96px; 
          }
        }
      </style>
      
      <div class="container">
        <div class=" justify-content-md-center pt-5">
       
      
            {% with allcomments.count as total_comments %}
            <h2>
              {{ total_comments }} comment{{ total_comments|pluralize }}
            </h2>
            <br />
            <br />

            {% endwith %}
      
            {% load mptt_tags %}
      
            <!-- recursive comment generate mttp -->
            <!-- <div class="col-md-8"> -->

              {% load mptt_tags %}
              <div class="allcommments">
        
                {% recursetree allcomments %}
                  <div id="{{ node.id }}" class="my-2 p-2" style="border: 0px solid grey">
          
          
                    <div class="d-flex justify-content-between">
          
                      <div><img class="avatar_single mr-3" src="{{ node.owner.profile_pic_url }}" style="height:40px; width:40px;border-radius: 50%;">By {{ node.owner }}</div>
                      {{ node.publish }}
          
          
                    </div>
          
                    <div class="node-content">{{ node.comment }}</div>
          
                    <div class="d-flex flex-row-reverse">
                      {% if node.level < 10 %}
                      <button class="btn btn-primary btn-sm" onclick="myFunction({{ node.id }})">Reply</button>
                      {% endif %}
                      {% if node.owner|stringformat:"s" ==  user_name  %}
                      <button class="btn btn-secondary btn-sm mr-2" onclick="deleteComment({{ node.id }})">Delete</button>
                      {% endif %}
                    </div>
                    <hr />
                  </div>
                  {% if not node.is_leaf_node %}
                    <div class="children pl-2 pl-md-5">
                      {{ children }}
                    </div>
                  {% endif %}
                {% endrecursetree %}
        
              </div> 
            <!-- </div> -->
      
            
      
            <!-- for for creating new comment -->
            {% if is_authenticated is True %}
                <div id="myDIV" style="display:block;">
                <form id="myForm" method="post">
                    <h2>Create new comment</h2>
                    {{ comment_form.as_p  }}
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Submit</button>
                </form>
                </div>
            {% else %}
                <h2>Please Log In to Comment</h2>
            {% endif %}
      
          </div>
        </div>
      </div>
      <script>
        //Comments
      
        $(document).on('click', '#newcommentform, #newcommentinner', function (e) {
          e.preventDefault();
      
          var button = $(this).attr("value");
          console.log($("#" + button).serialize());
          var placement = "commentform"
          if (button == "newcommentform") {
            var placement = "newcommentform"
          }
      
          $.ajax({
            type: 'POST',
            url: '{% url "addcomment" %}',
            data: $("#" + button).serialize(),
            cache: false,
            success: function (json) {  
              
              $('<div id="'+ json['comment_id'] +'" class="my-2 p-2" style="border: 1px solid grey"> \
                <div class="d-flex justify-content-between">By ' + json['user'] + '<div></div>Posted: Just now!</div> \
                <div>' + json['result'] + '</div> \
                <hr> \
                <button class="mr-1 btn btn-primary btn-sm" onclick="myFunction('+json['comment_id']+')">Reply</button>\
                </div>').insertBefore('#' + placement);
      
              $('.commentform').trigger("reset");
              formExit()
      
            },
            error: function (xhr, errmsg, err) {
      
            }
          });
        })
      
        function formExit() {
          // e.preventDefault();
          document.getElementById("newcommentform").remove();
          $("#newcommentform").remove();
        }
      
        function deleteComment(id) {
          console.log(id)
          $.ajax({
            type: 'POST',
            url: '{% url "addcomment" %}',
            data: {
              nodeid: id,
              action: 'delete',
              csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
            },
            success: function (json) {
              $("#" + json['remove']).remove();
            },
            error: function (xhr, errmsg, err) {}
          });
        }
      
        function myFunction(id) {
          if (document.contains(document.getElementById("newcommentform"))) {
            document.getElementById("newcommentform").remove();
          }
          var postid = "{{ posts.id }}";
          // console.log("{{ posts.id }}");
          // var imgFullURL = $('img.avatar_comment')[0].src;
          var d1 = document.getElementById(id);
          if("{{is_authenticated}}"==="True"){
                d1.insertAdjacentHTML('afterend',
                    '<form id="newcommentform" class="commentform" method="post"> \
                    {% csrf_token %} \
                    <select name="post" class="d-none" id="id_post"> \
                      <option value="' + postid + '" selected="' + postid + '"></option> \
                    </select> <label class="small font-weight-bold"></label> \
                    <select name="parent" class="d-none" id="id_parent"> \
                        <option value="' + id + '" selected="' + id + '"></option> \
                    </select> \
                    <div class="d-flex"> \
                        <textarea name="comment" cols="40" rows="1" class=" ml-3 mb-3 form-control border-0 comment-add rounded-0" placeholder="Add a public comment" required="" id="id_comment" ></textarea> \
                    </div> \
                    <div class="d-flex flex-row-reverse"> \
                        <button type="button" class="btn btn-outline-secondary" onclick="formExit()">Close</button> \
                        <button value="newcommentform" id="newcommentinner" type="submit" class="mr-1 newcomment btn btn-primary ">Submit</button> \
                    </div> \
                    </form>'
                );
          }
          else{
              alert('Please Log In to Comment'); 
          }
        }
        
      
      
        //Reset form on page reload
      
        $('.commentform').trigger("reset");
      
      
      
      
        
      </script>
</body>

</html>
{% endblock %}